# Фінансовий облік пристроїв

## Реалізовано

### 1. Фінансові поля в моделі Device

Додано наступні поля:
- `purchase_price` - вартість покупки (Numeric 10,2)
- `purchase_date` - дата покупки
- `depreciation_rate` - відсоток амортизації на рік (за замовчуванням 20%)
- `repair_expenses` - зв'язок з моделлю RepairExpense

### 2. Нова модель RepairExpense

Модель для обліку витрат на ремонт:

**Поля:**
- `id` - унікальний ідентифікатор
- `device_id` - ідентифікатор пристрою (Foreign Key)
- `amount` - сума витрат (Numeric 10,2)
- `description` - опис виконаних робіт
- `repair_date` - дата ремонту
- `invoice_number` - номер накладної
- `created_at` - дата створення запису

### 3. Розрахункові властивості (Properties)

**current_value** - поточна вартість пристрою
```python
@property
def current_value(self):
    """Поточна вартість пристрою з урахуванням амортизації"""
    # Лінійна амортизація
    years_old = (today - purchase_date).days / 365.25
    depreciation = purchase_price * (depreciation_rate / 100) * years_old
    return max(purchase_price - depreciation, 0)
```

**total_repair_expenses** - загальні витрати на ремонт
```python
@property
def total_repair_expenses(self):
    """Загальні витрати на ремонт"""
    return sum(float(exp.amount) for exp in self.repair_expenses)
```

**total_cost** - загальна вартість (покупка + ремонт)
```python
@property
def total_cost(self):
    """Загальна вартість (покупка + ремонт)"""
    return purchase_price + total_repair_expenses
```

### 4. Backend функціонал

#### Нові маршрути (blueprints/devices.py):

1. **`/device/<device_id>/add-repair-expense`** - додавання витрат на ремонт
   - POST метод
   - Обробка форми з даними витрат
   - Валідація даних
   - Логування активності

2. **`/device/repair-expense/<expense_id>/delete`** - видалення витрат
   - POST метод
   - Перевірка прав доступу
   - Логування видалення

#### Оновлені маршрути:

1. **`edit_device()`** - додано обробку фінансових полів
   - Збереження вартості покупки
   - Збереження дати покупки
   - Збереження відсотка амортизації
   - Запис в історію змін

### 5. Форми та UI

#### Форма редагування пристрою (templates/edit_device.html):

Додано секцію "Фінансова інформація":
- Поле "Вартість покупки"
- Поле "Дата покупки"
- Поле "Відсоток амортизації"
- Підказки для користувача

#### Детальна картка пристрою (templates/device_detail.html):

Додано дві нові секції:

1. **Фінансова інформація**
   - Вартість покупки (великим шрифтом, синім кольором)
   - Поточна вартість (великим шрифтом, зеленим кольором)
   - Витрати на ремонт (великим шрифтом, червоним кольором)
   - Дата покупки та відсоток амортизації

2. **Витрати на ремонт**
   - Таблиця з усіма витратами
   - Модальне вікно для додавання
   - Підсумок загальних витрат
   - Можливість видалення кожної витрати

#### Модальне вікно для додавання витрат:

Поля форми:
- Дата ремонту (обов'язкове, за замовчуванням сьогодні)
- Сума (обов'язкове, decimal)
- Номер накладної (опціональне)
- Опис робіт (опціональне, textarea)

### 6. Міграція бази даних

**Створена міграція:** `907305a4ed6b`
- Додано 3 нових поля в таблицю `device`:
  - `purchase_price` NUMERIC(10,2)
  - `purchase_date` DATE
  - `depreciation_rate` NUMERIC(5,2)
- Створено нову таблицю `repair_expense`:
  - Всі поля моделі RepairExpense
  - Foreign key до device.id
  - Каскадне видалення

## Приклад використання

### Введення фінансової інформації

1. Відкрити картку пристрою
2. Натиснути "Редагувати"
3. Прокрутити до секції "Фінансова інформація"
4. Заповнити:
   - Вартість покупки: 15000 грн
   - Дата покупки: 01.01.2022
   - Відсоток амортизації: 20% (за замовчуванням)
5. Зберегти

### Додавання витрат на ремонт

1. Відкрити картку пристрою
2. Знайти секцію "Витрати на ремонт"
3. Натиснути "Додати витрати"
4. Заповнити форму:
   - Дата: 15.10.2024
   - Сума: 2500 грн
   - Накладна: №12345
   - Опис: Заміна жорсткого диска
5. Натиснути "Додати"

### Перегляд фінансової інформації

На картці пристрою відображається:
- **Вартість покупки:** 15000 грн (синім кольором)
- **Поточна вартість:** 10000 грн (зеленим кольором)
  - Розраховано: 15000 - (15000 * 20% * 1.7років) = 9900 грн
- **Витрати на ремонт:** 2500 грн (червоним кольором)
- **Загальна вартість:** 15000 + 2500 = 17500 грн

## Амортизація

### Лінійна амортизація

Формула: `depreciation = purchase_price * (rate / 100) * years_old`

**Приклад:**
- Покупка: 10000 грн
- Дата: 01.01.2022
- Амортизація: 20% на рік
- Сьогодні: 01.10.2024
- Років: 2.75
- Відшкодування: 10000 * 0.20 * 2.75 = 5500 грн
- Поточна вартість: 10000 - 5500 = 4500 грн

### Налаштування амортизації

- Стандартна для техніки: 20% на рік
- Для швидко зношуючої техніки: 25-30%
- Для довготривалої техніки: 10-15%

## Облік витрат

### Загальна вартість пристрою

```
total_cost = purchase_price + total_repair_expenses
```

Це дає повну картину реальної вартості пристрою з урахуванням:
- Початкової вартості покупки
- Всіх витрат на ремонт та обслуговування

### Приклад

```
Пристрій: Dell OptiPlex 7090

Покупка:
  - Сума: 15000 грн
  - Дата: 01.01.2022
  - Амортизація: 20%

Поточна вартість: 9900 грн

Витрати на ремонт:
  1. 15.05.2023: Заміна ОЗП - 1500 грн
  2. 10.09.2024: Заміна HDD - 2500 грн
  Всього: 4000 грн

Загальна вартість: 19000 грн
```

## Безпека

1. **Перевірка доступу**
   - Тільки авторизовані користувачі
   - Фільтрація по містам

2. **Логування активності**
   - Всі зміни записуються в історію
   - Відслідковується IP та User-Agent

3. **Валідація даних**
   - Перевірка типів даних
   - Обов'язкові поля
   - Форматування чисел

## Зміни в БД

```sql
-- Додано поля в таблицю device
ALTER TABLE device ADD COLUMN purchase_price NUMERIC(10,2);
ALTER TABLE device ADD COLUMN purchase_date DATE;
ALTER TABLE device ADD COLUMN depreciation_rate NUMERIC(5,2) DEFAULT 20.0;

-- Створено таблицю repair_expense
CREATE TABLE repair_expense (
    id INTEGER PRIMARY KEY,
    device_id INTEGER NOT NULL,
    amount NUMERIC(10,2) NOT NULL,
    description VARCHAR(500),
    repair_date DATE NOT NULL,
    invoice_number VARCHAR(100),
    created_at DATETIME,
    FOREIGN KEY (device_id) REFERENCES device (id) ON DELETE CASCADE
);
```

## Статистика та звіти

Майбутні покращення:
1. Звіт загальної вартості всіх пристроїв
2. Найбільш дорогі пристрої
3. Тренд витрат на ремонт
4. Економічний звіт (амортизація vs витрати)
5. Прогноз заміни обладнання

## Використання в бізнесі

### Приклад звіту

```
ЗВІТ ПО ФІНАНСАХ ТЕХНІКИ
Місто: Київ

Пристрої: 45 шт
Загальна вартість покупки: 675000 грн
Поточна вартість (з амортизацією): 445000 грн
Витрати на ремонт: 12500 грн
Загальна вартість: 687500 грн

Списання за місяць: 12000 грн
```

Дозволяє:
- Контролювати бюджет
- Планувати заміну обладнання
- Оцінювати реальну вартість активів
- Аналізувати витрати на техніку

