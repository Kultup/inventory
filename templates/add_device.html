{% extends "base.html" %}

{% block content %}
<h2 class="mb-4">Додати новий пристрій</h2>
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="row">
    <div class="col-lg-8">
        <form method="POST" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            
            <!-- Основна інформація -->
            <div class="card mb-3">
        <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-info-circle"></i> Основна інформація</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="name" class="form-label">Назва <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="name" name="name" value="{{ request.form.get('name', '') }}" required placeholder="Наприклад: Dell OptiPlex 7090">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="type" class="form-label">Тип пристрою <span class="text-danger">*</span></label>
                    <select class="form-select" id="type" name="type" required>
                        <option value="">Виберіть тип</option>
                        <option value="Комп'ютер" {% if request.form.get('type') == "Комп'ютер" %}selected{% endif %}>Комп'ютер</option>
                        <option value="Ноутбук" {% if request.form.get('type') == "Ноутбук" %}selected{% endif %}>Ноутбук</option>
                        <option value="Принтер" {% if request.form.get('type') == "Принтер" %}selected{% endif %}>Принтер</option>
                        <option value="Мережеве обладнання" {% if request.form.get('type') == "Мережеве обладнання" %}selected{% endif %}>Мережеве обладнання</option>
                        <option value="Інше" {% if request.form.get('type') == "Інше" %}selected{% endif %}>Інше</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="serial_number" class="form-label">Серійний номер <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="serial_number" name="serial_number" value="{{ request.form.get('serial_number', '') }}" required placeholder="Наприклад: ABC123456789">
                    <div class="form-text">Інвентарний номер буде згенеровано автоматично.</div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="status" class="form-label">Статус <span class="text-danger">*</span></label>
                    <select class="form-select" id="status" name="status" required>
                        <option value="">Виберіть статус</option>
                        <option value="В експлуатації" {% if request.form.get('status') == "В експлуатації" %}selected{% endif %}>В експлуатації</option>
                        <option value="На ремонті" {% if request.form.get('status') == "На ремонті" %}selected{% endif %}>На ремонті</option>
                        <option value="Резерв" {% if request.form.get('status') == "Резерв" %}selected{% endif %}>Резерв</option>
                        <option value="Списано" {% if request.form.get('status') == "Списано" %}selected{% endif %}>Списано</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Розташування -->
    <div class="card mb-3">
        <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-map-marker-alt"></i> Розташування</h6>
        </div>
        <div class="card-body">
            <div class="row">
                {% if current_user.is_admin and cities|length > 1 %}
                <div class="col-md-6 mb-3">
                    <label for="city_id" class="form-label">Місто <span class="text-danger">*</span></label>
                    <select class="form-select" id="city_id" name="city_id" required>
                        {% for city in cities %}
                        <option value="{{ city.id }}" {% if request.form.get('city_id')|int == city.id %}selected{% elif city.id == current_user.city_id and not request.form.get('city_id') %}selected{% endif %}>{{ city.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                {% else %}
                <div class="col-12 mb-3">
                {% endif %}
                    <label for="location" class="form-label">Розташування <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="location" name="location" value="{{ request.form.get('location', '') }}" required placeholder="Наприклад: Офіс 201, кімната 15">
                </div>
            </div>
        </div>
    </div>

    <!-- Додаткова інформація -->
    <div class="card mb-3">
        <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-cogs"></i> Додаткова інформація</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="last_maintenance" class="form-label">Дата останнього обслуговування</label>
                    <input type="date" class="form-control" id="last_maintenance" name="last_maintenance" value="{{ request.form.get('last_maintenance', '') }}">
                    <div class="form-text">Залиште порожнім, якщо не було обслуговування.</div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="maintenance_interval" class="form-label">Інтервал обслуговування (днів)</label>
                    <input type="number" class="form-control" id="maintenance_interval" name="maintenance_interval" value="{{ request.form.get('maintenance_interval', '365') }}" min="1">
                    <div class="form-text">Кількість днів до наступного планового обслуговування.</div>
                </div>
            </div>
            <div class="mb-3">
                <label for="notes" class="form-label">Примітки</label>
                <textarea class="form-control" id="notes" name="notes" rows="2" placeholder="Додаткова інформація про пристрій...">{{ request.form.get('notes', '') }}</textarea>
            </div>
        </div>
    </div>

    <!-- Фотографії -->
    <div class="card mb-3">
        <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-camera"></i> Фотографії пристрою</h6>
        </div>
        <div class="card-body">
            <div class="drag-drop-area" id="dragDropArea">
                <div class="drag-drop-content">
                    <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                    <p class="mb-1">Перетягніть файли сюди або <span class="text-primary">натисніть для вибору</span></p>
                    <p class="text-muted small">Підтримуються формати JPG, PNG, GIF</p>
                </div>
                <input type="file" class="form-control d-none" id="photos" name="photos" multiple accept="image/*">
            </div>
            <div id="fileList" class="mt-2"></div>
        </div>
    </div>

            <div class="d-flex gap-2 mb-3">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Додати пристрій
                </button>
                <a href="{{ url_for('devices.devices') }}" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Скасувати
                </a>
            </div>
        </form>
    </div>
    <div class="col-lg-4">
        <div class="card bg-light">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-lightbulb text-warning"></i> Приклади заповнення</h6>
            </div>
            <div class="card-body p-3">
                <button class="btn btn-sm btn-outline-primary mb-2 w-100" onclick="fillExample('computer')">
                    <i class="fas fa-desktop"></i> Комп'ютер
                </button>
                <button class="btn btn-sm btn-outline-success mb-2 w-100" onclick="fillExample('laptop')">
                    <i class="fas fa-laptop"></i> Ноутбук
                </button>
                <button class="btn btn-sm btn-outline-info mb-2 w-100" onclick="fillExample('printer')">
                    <i class="fas fa-print"></i> Принтер
                </button>
                <button class="btn btn-sm btn-outline-warning w-100" onclick="fillExample('network')">
                    <i class="fas fa-network-wired"></i> Мережеве обладнання
                </button>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> Натисніть на приклад для автозаповнення форми
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.drag-drop-area {
    border: 2px dashed #dee2e6;
    border-radius: 0.375rem;
    padding: 1.5rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background-color: #f8f9fa;
}

.drag-drop-area:hover {
    border-color: #0d6efd;
    background-color: #e7f1ff;
}

.drag-drop-area.dragover {
    border-color: #0d6efd;
    background-color: #e7f1ff;
    transform: scale(1.02);
}

.card-header h6 {
    color: #495057;
    font-weight: 600;
}

.file-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    background-color: #f8f9fa;
    border-radius: 0.25rem;
    border: 1px solid #dee2e6;
}

.file-item .file-info {
    display: flex;
    align-items: center;
}

.file-item .file-icon {
    margin-right: 0.5rem;
    color: #6c757d;
}

.file-item .remove-file {
    color: #dc3545;
    cursor: pointer;
    padding: 0.25rem;
}

.file-item .remove-file:hover {
    color: #b02a37;
}

[data-bs-theme="dark"] .drag-drop-area {
    background-color: #2d2d2d;
    border-color: #495057;
}

[data-bs-theme="dark"] .drag-drop-area:hover {
    border-color: #6ea8fe;
    background-color: #1e3a5f;
}

[data-bs-theme="dark"] .drag-drop-area.dragover {
    border-color: #6ea8fe;
    background-color: #1e3a5f;
}

[data-bs-theme="dark"] .file-item {
    background-color: #2d2d2d;
    border-color: #495057;
}
</style>

<script>
// Функція для заповнення прикладів
function fillExample(type) {
    const examples = {
        computer: {
            name: 'Dell OptiPlex 7090',
            type: 'Комп\'ютер',
            serial_number: 'DL7090ABC123',
            location: 'Офіс 201, робоче місце 15',
            status: 'В експлуатації',
            notes: 'Робоча станція для бухгалтерії. Intel Core i5, 8GB RAM, SSD 256GB'
        },
        laptop: {
            name: 'Lenovo ThinkPad E15',
            type: 'Ноутбук',
            serial_number: 'LN15TPE456789',
            location: 'Мобільне робоче місце',
            status: 'В експлуатації',
            notes: 'Ноутбук для віддаленої роботи. Intel Core i7, 16GB RAM, SSD 512GB'
        },
        printer: {
            name: 'HP LaserJet Pro M404dn',
            type: 'Принтер',
            serial_number: 'HP404LJ789012',
            location: 'Офіс 105, загальна зона',
            status: 'В експлуатації',
            notes: 'Чорно-білий лазерний принтер для офісу. Двостороння печать, мережевий'
        },
        network: {
            name: 'Cisco Catalyst 2960-X',
            type: 'Мережеве обладнання',
            serial_number: 'CS2960X345678',
            location: 'Серверна кімната, стійка R1',
            status: 'В експлуатації',
            notes: 'Мережевий комутатор 24 порти. Управляємий, підтримка VLAN'
        }
    };

    const example = examples[type];
    if (example) {
        document.getElementById('name').value = example.name;
        document.getElementById('type').value = example.type;
        document.getElementById('serial_number').value = example.serial_number;
        document.getElementById('location').value = example.location;
        document.getElementById('status').value = example.status;
        document.getElementById('notes').value = example.notes;
        
        // Показуємо повідомлення
        showToast('Приклад заповнено! Ви можете змінити будь-які поля.', 'success');
    }
}

// Функція для показу toast повідомлень
function showToast(message, type = 'info') {
    // Створюємо toast елемент
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    // Автоматично видаляємо через 3 секунди
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 3000);
}

document.addEventListener('DOMContentLoaded', function() {
    const dragDropArea = document.getElementById('dragDropArea');
    const fileInput = document.getElementById('photos');
    const fileList = document.getElementById('fileList');
    let selectedFiles = [];

    // Клік по області для вибору файлів
    dragDropArea.addEventListener('click', function() {
        fileInput.click();
    });

    // Обробка вибору файлів через input
    fileInput.addEventListener('change', function(e) {
        handleFiles(e.target.files);
    });

    // Drag & Drop події
    dragDropArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        dragDropArea.classList.add('dragover');
    });

    dragDropArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        dragDropArea.classList.remove('dragover');
    });

    dragDropArea.addEventListener('drop', function(e) {
        e.preventDefault();
        dragDropArea.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    });

    function handleFiles(files) {
        for (let file of files) {
            if (file.type.startsWith('image/')) {
                selectedFiles.push(file);
            }
        }
        updateFileList();
        updateFileInput();
    }

    function updateFileList() {
        fileList.innerHTML = '';
        selectedFiles.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <div class="file-info">
                    <i class="fas fa-image file-icon"></i>
                    <span>${file.name} (${formatFileSize(file.size)})</span>
                </div>
                <i class="fas fa-times remove-file" onclick="removeFile(${index})"></i>
            `;
            fileList.appendChild(fileItem);
        });
    }

    function updateFileInput() {
        const dt = new DataTransfer();
        selectedFiles.forEach(file => dt.items.add(file));
        fileInput.files = dt.files;
    }

    window.removeFile = function(index) {
        selectedFiles.splice(index, 1);
        updateFileList();
        updateFileInput();
    };

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
});
</script>

{% endblock %}