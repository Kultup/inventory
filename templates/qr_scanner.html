{% extends "base.html" %}

{% block title %}QR Сканер{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-qr-code-scan"></i>
                        Сканер QR-кодів
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Кнопки управління -->
                    <div class="mb-3 text-center">
                        <button id="startButton" class="btn btn-success btn-lg">
                            <i class="bi bi-camera"></i> Запустити камеру
                        </button>
                        <button id="stopButton" class="btn btn-danger btn-lg" style="display: none;">
                            <i class="bi bi-stop-circle"></i> Зупинити
                        </button>
                    </div>

                    <!-- Вибір камери -->
                    <div class="mb-3" id="cameraSelectDiv" style="display: none;">
                        <label for="cameraSelect" class="form-label">Оберіть камеру:</label>
                        <select id="cameraSelect" class="form-select">
                        </select>
                    </div>

                    <!-- Відео з камери -->
                    <div id="reader" class="mb-3" style="display: none; border: 2px solid #ddd; border-radius: 8px;"></div>

                    <!-- Результат сканування -->
                    <div id="result" class="alert alert-info" style="display: none;">
                        <h5><i class="bi bi-check-circle"></i> Відскановано:</h5>
                        <div id="resultText"></div>
                    </div>

                </div>
            </div>

            <!-- Ручне введення -->
            <div class="card shadow mt-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-keyboard"></i>
                        Або введіть ID пристрою вручну
                    </h5>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('devices.device_detail', device_id=0) }}" method="get" id="manualForm">
                        <div class="input-group">
                            <input type="number" class="form-control" id="manualDeviceId" 
                                   placeholder="Введіть ID пристрою" required min="1">
                            <button class="btn btn-primary" type="submit">
                                <i class="bi bi-search"></i> Знайти
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
let html5QrCode;
let currentCameraId;
let isScanning = false;

const startButton = document.getElementById('startButton');
const stopButton = document.getElementById('stopButton');
const reader = document.getElementById('reader');
const result = document.getElementById('result');
const resultText = document.getElementById('resultText');
const cameraSelectDiv = document.getElementById('cameraSelectDiv');
const cameraSelect = document.getElementById('cameraSelect');
const manualForm = document.getElementById('manualForm');

// Функція успішного сканування
function onScanSuccess(decodedText, decodedResult) {
    console.log(`Відскановано: ${decodedText}`);
    
    resultText.innerHTML = `<pre>${decodedText}</pre>`;
    result.style.display = 'block';
    
    // Спробуємо знайти ID пристрою у відсканованому тексті
    const idMatch = decodedText.match(/ID:\s*(\d+)/i);
    
    if (idMatch && idMatch[1]) {
        const deviceId = idMatch[1];
        
        // Показуємо повідомлення
        resultText.innerHTML += `<p class="mt-2"><strong>Знайдено пристрій ID: ${deviceId}</strong></p>`;
        resultText.innerHTML += `<div class="spinner-border spinner-border-sm" role="status"></div> Перенаправлення...`;
        
        // Зупиняємо сканер
        stopScanning();
        
        // Перенаправлення через 1.5 секунди
        setTimeout(() => {
            window.location.href = `/device/${deviceId}`;
        }, 1500);
    } else {
        resultText.innerHTML += `<p class="text-warning mt-2">ID пристрою не знайдено в QR-коді</p>`;
    }
}

// Функція помилки сканування
function onScanError(errorMessage) {
    // Ігноруємо часті помилки "не знайдено QR код"
    // console.log(errorMessage);
}

// Перевірка підтримки камери
function checkCameraSupport() {
    const isSecure = window.location.protocol === 'https:' || 
                     window.location.hostname === 'localhost' || 
                     window.location.hostname === '127.0.0.1';
    
    if (!isSecure) {
        return {
            supported: false,
            error: 'Для роботи камери потрібен HTTPS або доступ через localhost/127.0.0.1. ' +
                   'Поточний протокол: ' + window.location.protocol + '. ' +
                   'Будь ласка, використовуйте HTTPS або відкрийте сайт через localhost.'
        };
    }
    
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        return {
            supported: false,
            error: 'Ваш браузер не підтримує доступ до камери. Спробуйте інший браузер.'
        };
    }
    
    return { supported: true };
}

// Запуск сканера
async function startScanning() {
    if (isScanning) {
        return;
    }
    
    // Перевіряємо підтримку камери
    const cameraCheck = checkCameraSupport();
    if (!cameraCheck.supported) {
        resultText.innerHTML = `<div class="alert alert-danger">
            <strong>Помилка:</strong> ${cameraCheck.error}<br>
            <small>Для роботи камери на мобільних пристроях потрібен HTTPS.</small>
        </div>`;
        result.style.display = 'block';
        return;
    }
    
    try {
        // Показуємо індикацію завантаження
        startButton.disabled = true;
        startButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Завантаження...';
        
        if (!html5QrCode) {
            html5QrCode = new Html5Qrcode("reader");
        }
        
        // Отримуємо список камер
        let devices;
        try {
            devices = await Html5Qrcode.getCameras();
        } catch (err) {
            console.error('Помилка отримання камер:', err);
            
            // Детальна обробка помилок
            let errorMessage = 'Не вдалося отримати доступ до камери. ';
            if (err.name === 'NotAllowedError') {
                errorMessage += 'Дозвіл на використання камери було відхилено. Перевірте налаштування браузера.';
            } else if (err.name === 'NotFoundError') {
                errorMessage += 'Камеру не знайдено. Перевірте, чи підключена камера.';
            } else if (err.name === 'NotReadableError') {
                errorMessage += 'Камера зайнята іншим додатком. Закрийте інші програми, які використовують камеру.';
            } else {
                errorMessage += 'Помилка: ' + err.message;
            }
            
            throw new Error(errorMessage);
        }
        
        if (devices && devices.length) {
            // Заповнюємо список камер
            cameraSelect.innerHTML = '';
            devices.forEach((device, index) => {
                const option = document.createElement('option');
                option.value = device.id;
                option.text = device.label || `Камера ${index + 1}`;
                cameraSelect.appendChild(option);
            });
            
            // Показуємо вибір камери якщо їх більше однієї
            if (devices.length > 1) {
                cameraSelectDiv.style.display = 'block';
            }
            
            // Використовуємо задню камеру за замовчуванням (для мобільних)
            // Шукаємо камеру з "back", "rear", "environment" в назві
            const backCamera = devices.find(d => {
                const label = d.label.toLowerCase();
                return label.includes('back') || label.includes('rear') || label.includes('environment');
            }) || devices[devices.length - 1]; // Якщо не знайдено, беремо останню (зазвичай задню)
            
            currentCameraId = backCamera.id;
            cameraSelect.value = currentCameraId;
            
            // Визначаємо розмір qrbox в залежності від розміру екрану
            const isMobile = window.innerWidth <= 768;
            const qrboxSize = isMobile ? Math.min(250, window.innerWidth * 0.8) : 250;
            
            // Запускаємо сканування з покращеними налаштуваннями для мобільних
            try {
                await html5QrCode.start(
                    currentCameraId,
                    {
                        fps: 10,
                        qrbox: function(viewfinderWidth, viewfinderHeight) {
                            // Адаптивний розмір qrbox
                            const minEdgePercentage = 0.7;
                            const minEdgeSize = Math.min(viewfinderWidth, viewfinderHeight);
                            const qrboxSize = Math.floor(minEdgeSize * minEdgePercentage);
                            return {
                                width: qrboxSize,
                                height: qrboxSize
                            };
                        },
                        aspectRatio: 1.0,
                        videoConstraints: {
                            facingMode: "environment", // Задня камера на мобільних
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    },
                    onScanSuccess,
                    onScanError
                );
            } catch (startErr) {
                console.error('Помилка запуску сканера:', startErr);
                throw new Error('Не вдалося запустити камеру. Перевірте дозволи браузера та налаштування.');
            }
            
            isScanning = true;
            reader.style.display = 'block';
            startButton.style.display = 'none';
            stopButton.style.display = 'inline-block';
            result.style.display = 'none';
        } else {
            throw new Error('Камеру не знайдено. Перевірте дозволи браузера.');
        }
    } catch (err) {
        console.error('Помилка запуску камери:', err);
        isScanning = false;
        startButton.disabled = false;
        startButton.innerHTML = '<i class="bi bi-camera"></i> Запустити камеру';
        
        let errorMsg = 'Помилка запуску камери. ';
        if (err.message) {
            errorMsg += err.message;
        } else {
            errorMsg += 'Переконайтеся, що ви надали дозвіл на використання камери.';
        }
        
        // Показуємо детальну помилку
        resultText.innerHTML = `<div class="alert alert-danger">
            <strong>Помилка:</strong> ${errorMsg}<br>
            <small>Перевірте налаштування браузера та дозволи для камери.</small>
        </div>`;
        result.style.display = 'block';
    }
}

// Зупинка сканера
async function stopScanning() {
    if (!isScanning) {
        return;
    }
    
    try {
        if (html5QrCode) {
            await html5QrCode.stop();
            await html5QrCode.clear();
        }
        isScanning = false;
        reader.style.display = 'none';
        startButton.style.display = 'inline-block';
        startButton.disabled = false;
        startButton.innerHTML = '<i class="bi bi-camera"></i> Запустити камеру';
        stopButton.style.display = 'none';
        cameraSelectDiv.style.display = 'none';
    } catch (err) {
        console.error('Помилка зупинки камери:', err);
        isScanning = false;
        reader.style.display = 'none';
        startButton.style.display = 'inline-block';
        startButton.disabled = false;
        startButton.innerHTML = '<i class="bi bi-camera"></i> Запустити камеру';
        stopButton.style.display = 'none';
    }
}

// Зміна камери
cameraSelect.addEventListener('change', async function() {
    if (isScanning && html5QrCode) {
        await stopScanning();
        currentCameraId = this.value;
        await startScanning();
    }
});

// Обробники кнопок
startButton.addEventListener('click', startScanning);
stopButton.addEventListener('click', stopScanning);

// Ручне введення
manualForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const deviceId = document.getElementById('manualDeviceId').value;
    if (deviceId) {
        window.location.href = `/device/${deviceId}`;
    }
});

// Зупиняємо сканер при виході зі сторінки
window.addEventListener('beforeunload', function() {
    if (html5QrCode && html5QrCode.isScanning) {
        html5QrCode.stop();
    }
});
</script>
{% endblock %}

