# Посібник з оновлення системи інвентаризації

## Зміни в новій версії

### 1. Підтримка .env файлів
- Додано підтримку змінних оточення через `.env` файли
- Покращена безпека конфігурації

### 2. Flask-Migrate (Alembic)
- Впроваджено систему міграцій бази даних
- Автоматичне відстеження змін схеми БД

### 3. Автоматичне резервне копіювання
- Щоденне автоматичне створення backup о 2:00
- Очищення старих backup
- Адмін-панель для управління backup

### 4. Система нагадувань про обслуговування
- Автоматична перевірка пристроїв, яким потрібне обслуговування
- Нагадування для користувачів через модель Notification

### 5. REST API
- Повний REST API для управління пристроями
- Автентифікація через API ключі
- Endpoints: GET, POST, PUT, DELETE

### 6. Експорт в PDF
- Генерація інвентарних карток у форматі PDF
- Масовий експорт пристроїв
- QR коди в PDF документах

## Встановлення оновлень

### Крок 1: Резервне копіювання

**ВАЖЛИВО!** Перед оновленням створіть резервну копію бази даних:

```bash
# Зробіть копію поточної БД
cp instance/inventory_dev.db instance/inventory_dev.db.backup
```

### Крок 2: Оновлення залежностей

```bash
# Активуйте віртуальне середовище
source venv/bin/activate  # Linux/Mac
# або
venv\Scripts\activate  # Windows

# Встановіть нові залежності
pip install -r requirements.txt
```

### Крок 3: Налаштування .env файлу

1. Скопіюйте приклад конфігурації:
```bash
cp env.example .env
```

2. Відредагуйте `.env` файл і встановіть свої значення:
```env
SECRET_KEY=your-random-secret-key-here
DATABASE_URL=sqlite:///inventory.db
BACKUP_AUTO_ENABLED=true
```

3. Згенеруйте безпечний SECRET_KEY:
```python
python -c "import secrets; print(secrets.token_hex(32))"
```

### Крок 4: Ініціалізація міграцій

```bash
# Ініціалізуйте Flask-Migrate (тільки для першого запуску)
flask db init

# Створіть початкову міграцію
flask db migrate -m "Initial migration"

# Застосуйте міграцію
flask db upgrade
```

**Примітка:** Якщо у вас вже є база даних, міграції автоматично виявлять існуючі таблиці.

### Крок 5: Оновлення схеми БД

Нова версія додає таблицю `notification`. Виконайте міграцію:

```bash
flask db migrate -m "Add notification table"
flask db upgrade
```

### Крок 6: Перевірка налаштувань

Перевірте, що всі директорії створені:

```bash
# Створіть директорії, якщо їх немає
mkdir -p backups
mkdir -p static/uploads
mkdir -p instance
```

### Крок 7: Запуск системи

```bash
python app.py
```

Система запуститься з:
- Автоматичним планувальником задач
- Щоденним резервним копіюванням (якщо увімкнено)
- Перевіркою обслуговування пристроїв

## Використання нових функцій

### Резервне копіювання

Доступ до управління backup:
1. Увійдіть як адміністратор
2. Перейдіть в **Адмін-панель** → **Резервне копіювання**
3. Натисніть "Створити резервну копію" для ручного backup

### REST API

#### Отримання списку пристроїв:

```bash
curl -X GET http://localhost:5000/api/v1/devices \
  -H "X-API-Key: admin"
```

#### Створення пристрою:

```bash
curl -X POST http://localhost:5000/api/v1/devices \
  -H "X-API-Key: admin" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Принтер HP",
    "type": "Принтер",
    "serial_number": "SN123456",
    "location": "Офіс 201"
  }'
```

#### Оновлення пристрою:

```bash
curl -X PUT http://localhost:5000/api/v1/devices/1 \
  -H "X-API-Key: admin" \
  -H "Content-Type: application/json" \
  -d '{
    "status": "На ремонті",
    "notes": "Потребує заміни картриджа"
  }'
```

### Експорт в PDF

1. Відкрийте картку пристрою
2. Натисніть "Експорт в PDF"
3. PDF буде містити всю інформацію про пристрій + QR код

Для масового експорту:
1. Оберіть пристрої в списку (checkbox)
2. Натисніть "Експорт в PDF"

### Нагадування про обслуговування

Система автоматично перевіряє пристрої щодня о 9:00 та створює нагадування для користувачів, якщо:
- Обслуговування прострочене (тип: danger)
- Обслуговування незабаром (протягом 30 днів, тип: warning)

## Налаштування автоматичних задач

### Зміна часу резервного копіювання

Відредагуйте `app.py`, функція `init_scheduler()`:

```python
# Змініть час backup (наприклад, на 3:00)
scheduler.add_job(
    func=lambda: backup_database(app.config['BACKUP_FOLDER']),
    trigger=CronTrigger(hour=3, minute=0),  # Змінено з 2 на 3
    ...
)
```

### Вимкнення автоматичного backup

У файлі `.env`:

```env
BACKUP_AUTO_ENABLED=false
```

### Зміна періоду зберігання backup

У файлі `.env`:

```env
BACKUP_KEEP_DAYS=60  # Зберігати 60 днів замість 30
```

## Міграція з попередньої версії

Якщо у вас є старі дані:

1. Створіть backup поточної БД
2. Запустіть міграцію: `flask db upgrade`
3. Перевірте дані в системі
4. Видаліть старий скрипт `migrate_device_history.py` (більше не потрібен)

## Усунення проблем

### Помилка: "No such table: notification"

```bash
flask db upgrade
```

### Помилка: "SECRET_KEY not set"

Переконайтеся, що `.env` файл існує і містить `SECRET_KEY`.

### Планувальник не запускається

Перевірте логи при запуску. Має бути повідомлення:
```
Планувальник задач запущено
```

### API повертає 401

Перевірте, що ви передаєте правильний API ключ в заголовку `X-API-Key`.
Поки що використовується username користувача як API key.

## Подальші покращення

Заплановані функції:
- [ ] Візуалізація даних (Chart.js)
- [ ] Покращений UI (breadcrumbs, швидкі дії)
- [ ] Unit та integration тести
- [ ] JWT токени для API
- [ ] Email нагадування про обслуговування

## Підтримка

При виникненні проблем перевірте:
1. Логи системи (`inventory.log`)
2. Версії встановлених пакетів: `pip list`
3. Наявність всіх директорій (backups, uploads, instance)

## Changelog

### Версія 2.0 (Жовтень 2025)

**Додано:**
- Підтримка .env файлів
- Flask-Migrate для міграцій БД
- Автоматичне резервне копіювання
- Система нагадувань про обслуговування
- REST API
- Експорт в PDF
- APScheduler для автоматичних задач

**Покращено:**
- Безпека конфігурації
- Структура проекту
- Документація

**Виправлено:**
- Проблеми з видаленням пристроїв
- Відстеження історії змін

